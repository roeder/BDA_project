---
title: "Gender, Degrees and Wages: <br /><small>The Bayesian Workflow Applied to US Census Data</small>"
author: "Thilde Terkelsen & Timo Röder"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  tufte::tufte_html:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE)

library(tufte)
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)

custom_ggtheme <- theme_light() +
  theme(plot.background =
          element_rect(fill = "#fffff8",
                       colour = "#fffff8",
                       size = 0.5,
                       linetype = "solid"),
        panel.background =
          element_rect(fill = "#fffff8",
                       colour = "#fffff8",
                       size = 0.5,
                       linetype = "solid"),
        legend.box.background =
          element_rect(fill = "#fffff8",
                       colour = "#fffff8",
                       linetype = "solid"),
        legend.background = element_rect(fill = "#fffff8",
                                        colour = "#fffff8",
                                        linetype = "solid"),
        legend.key = element_rect(fill = "#fffff8",
                                        colour = "#fffff8",
                                        linetype = "solid"),
        legend.position = "bottom",
        panel.grid.major = element_line(linetype = "dotted"),
        panel.grid.minor = element_blank())

# ggtheme_tufte <- function() {
#   theme(plot.background =
#           element_rect(fill = "#fffff8",
#                        colour = "#fffff8",
#                        size = 0.5,
#                        linetype = "solid"),
#         plot.margin=unit(c(1, 1, 0.5, 0.5), "lines"),
#         panel.background =
#           element_rect(fill = "#fffff8",
#                        colour = "#fffff8",
#                        size = 0.5,
#                        linetype = "solid"),
#         panel.grid.major = element_line(colour = "white", size = 1, linetype="dashed"),
#           # blank(),
#         panel.grid.minor = element_blank(),
#         legend.box.background =
#           element_rect(fill = "#fffff8",
#                        colour = "#fffff8",
#                        linetype = "solid"),
#         axis.ticks = element_blank(),
#         axis.text = element_text(family = "Palatino", size = 16),
#         axis.title.x = element_text(family = "Palatino", size = 20,
#                                     margin = margin(t = 15, r = 0, b = 0, l = 0)),
#         axis.title.y = element_text(family = "Palatino", size = 18,
#                                     margin = margin(t = 0, r = 15, b = 0, l = 0)),
#         strip.background = element_rect(fill = "#fffff8",
#                                         colour = "#fffff8",
#                                         linetype = "solid"),
#         strip.text = element_text(family = "Palatino", size = 16),
#         legend.text = element_text(family = "Palatino", size = 16),
#         legend.title = element_text(family = "Palatino", size = 16,
#                                     margin = margin(b = 5)),
#         legend.background = element_rect(fill = "#fffff8",
#                                         colour = "#fffff8",
#                                         linetype = "solid"),
#         legend.key = element_rect(fill = "#fffff8",
#                                         colour = "#fffff8",
#                                         linetype = "solid")
#   )
# }
```

# Introduction
In this project we apply the Bayesian workflow to US census data from the years 2012 to 2016 in order to model wages and gender wage differences for college graduates from three academic fields living in New York state and Texas. 

The gender wage gap, i.e. the average difference in pay between men and women, 
continues to be a subject of great debate in academia, media, politics as well as in more informal settings.
Extensive studies on the wage gap's underlying mechanisms and its historical trends have arrived at somewhat varying conclusions. 
This is not too surprising: setting up appropriate study designs and statistical models to study people's wages is a fairly complex endeavour, as there are countless factors influencing the wage any individual receives. 
Variables such as educational level, field of study, maternity leave, work-life balance or even the income of an individual's parents, to name a few, confound the question of whether the differences in salaries observed is in fact due to gender bias or simply an artefact of other social, economic or familial circumstances.

An extensive report titled “Graduating to a Pay Gap” by Corbett and Hill (2012) [^1] explores the gender difference in US wages one year after graduation. 
Corbett and Hill compared the salaries of recent graduates who reported working the same number of hours per week, and found that one year after graduation women earned ~18% less than their male counterparts. 
As there are differences regarding the college majors and jobs that men and women tend to choose -- for instance, men are more likely to choose fields with relatively higher salaries such as engineering and computer science -- the study grouped college majors into more general categories.
Analyses were then performed separately for each category and compared afterwards.
While the study only found minor wage differences for majors in humanities, education and health sciences, there were significant gender wage gaps within the fields of engineering, computer science, business and social sciences. 

While the gender wage gap has shrunk in the US and other developed countries over the last 30 years, this wage convergence seems to stagnate at the moment [^2]. 
Along similar lines, a recent study of historical labour data has questioned the notion that some of the gender wage gap can still be attributed to gender differences in education [^3]. 
In the study, Blau and Kahn show that while in 1980 approximately 21.1% of the wage gap could be explained by work experience and 2.6% by educational level, by 2010 those numbers have decreased to 14.1% and -5.9% respectively, indicating that education is not a factor at all -- if anything, women nowadays earn too little compared to their educational level.

Coming back to this project, it should be said that our scope is a lot smaller compared to these studies.
We have not even attempted to disentangle the possible mechanisms underlying the wage gap.

Instead, our approach is rather descriptive:
we set out to investigate wage as a function of people's age and how this association may affect the gender wage gap -- does the gap grow or shrink when looking at different age cohorts? 
Is such an effect equally strong across different fields of work and different states or are wages consistently more equal in some of these groups ?
These are questions we would like to approach by applying the Bayesian workflow presented in the course.

While we cannot claim that the presented work provides ground-breaking answers to any unsolved research questions surrounding the gender wage gap, we hope that our report is still an informative and enjoyable read.

# Data

## From raw data to start of analysis
The data sources as well as some preliminary data cleaning steps are inspired by a *FiveThirtyEight* article from 2014: [*The Economic Guide To Picking A College Major*
](https://fivethirtyeight.com/features/the-economic-guide-to-picking-a-college-major/).

Our primary data source is the American Community Survey (ACS) Public Use Microdata Sample (PUMS) conducted by the United States Census Bureau.
The ACS conducts surveys of around 3.5 million households each year.

We are using the multiyear PUMS file covering census data for the years 2012 to 2016, which contains records on ~16 million individual residents.
It can be downloaded as `zip` file by selecting "United States Population Records" from [this website](https://factfinder.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_pums_csv_2012_2016&prodType=document). 
The `zip` file contains four large `csv` files which together cover the complete dataset.
Additional information on the PUMS files is provided on the US Census Bureau's website: they provide a general overview ([link to PDF](https://www.census.gov/content/dam/Census/programs-surveys/acs/guidance/training-presentations/20180214_PUMS.pdf)) as well as a data dictionary ([link to PDF](https://www2.census.gov/programs-surveys/acs/tech_docs/pums/data_dict/PUMS_Data_Dictionary_2012-2016.pdf)). 

In the first data cleaning step, we remove individuals who did not graduate college (see R script [here](https://github.com/roeder/BDA_project/blob/master/scripts/clean_raw_csv.R)) and write the remaining 3,489,070 entries to a file called `us16_filtered.csv`. 

Next up, we add information about college majors by merging our dataset with a lookup file called `majors-list.csv` prepared by *FiveThirtyEight* ([GitHub link](https://github.com/fivethirtyeight/data/blob/master/college-majors/majors-list.csv)).
This lookup file matches the `FOD1P` codes used in the PUMS to actual names of the corresponding college majors.
Additionally, these college majors are grouped into categories as used in a major 2011 study [^4].

You can find the R script we used to merge datasets [on GitHub](https://github.com/roeder/BDA_project/blob/master/scripts/aggregate_us_16.R).
This script also converts all wages reported before 2016 to inflation-adjusted wages equivalent to 2016 dollars, before writing selected columns for the 3,489,070 entries to a file called `selected_vars.csv`.

## Intermission: what is it we actually want to do?
Before moving on with the data preparation steps, it is probably a good idea to set the stage regarding what we want to model and why.
Hopefully, this will make some of the following sections easier to follow.

As touched upon in the introduction, our intention here is to run relatively straightforward hierarchical regression models in order to model wages across different ages.
Doing this in a Bayesian setting of course allows us to draw posterior predictive samples from the fitted models and we can use these posterior draws to answer some questions about the data.

For instance, you will see that the wage gap in absolute dollar values is substantially smaller when looking at education graduates as opposed to business graduates. 
However, wages are generally lower in the education group, so the observation about the wage gap might just be a side effect of this general difference in wages.
Drawing posterior predictive samples allows us to check if the difference in the wage gap holds up when looking at relative values rather than absolute ones.

## Selecting the data subset
The file `selected_vars.csv` is the starting point for our actual analysis:
```{r starting_csv, cache=TRUE}
library(readr)
selected_vars <- read_csv("data/selected_vars.csv")
selected_vars
```

It contains nine variables:

* `SERIALNO`: ID number for each entry
* `ST`: two-digit code for US states
* `AGEP`: age of survey respondent (at time of answering)
* `SEX`: survey respondent's gender
* `FOD1P`: four-digit code for college major
* `Major`: corresponding college major (173 majors in total)
* `Major_Category`: college major category (16 categories in total)
* `real_total_earn`: inflation-adjusted reported yearly total earnings (in 2016 USD)
* `real_wage`: inflation-adjusted reported yearly wages (in 2016 USD)

While it would of course be most appropriate to conduct an analysis on the complete dataset, we chose to focus only on a select subset of entries in order to keep both computation times and model interpretation manageable.
Our chosen subset consists of entries from two states and three major categories.

We choose New York and Texas as two similarly large states which should serve as decent stand-ins for politically opposed *blue states* (NY) and *red states* (TX).
The major categories we focus on are business, education and health.
We select the data subset with the following R code:
```{r select_subset, cache=TRUE}
library(dplyr)
nytx_df <- selected_vars %>% 
  filter(ST %in% c(36, 48),
         Major_Category %in% c("Education", "Health", "Business"),
         real_wage > 0) %>% 
  mutate(state = if_else(ST == 36, "NY", "TX"),
         sex = if_else(SEX == 1, "male", "female"))
```

Note that in the above code chunk, we also remove respondents who reported no wage and recode `ST` and `SEX` into the more explicit variables `state` and `sex`.

The resulting subset contains 148,490 entries, which can be broken down as follows:
```{r nytx_nos, results='asis'}
library(tidyr)
nytx_df %>% 
  group_by(Major_Category, state, sex) %>% 
  summarise(entries = n()) %>% 
  spread(key = "sex", value = "entries") %>% 
  mutate(ratio = female / male,
         total = male + female) %>% 
  knitr::kable(., digits = 2, format.args = list(big.mark = ","),
               col.names = c("major category", "state", "female", "male",
                             "ratio (f/m)", "total"))
```

We can see that both total number and gender ratio of entries for the two states are roughly comparable across the three major categories.

## Data summaries
In order to get an overview of the general trend in wages as a function of age, we plot the mean and variation of yearly wages across the age range from 20 to 70:

```{r data_time_plot, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
library(ggplot2)
theme_set(custom_ggtheme)

nytx_df %>% 
  filter(AGEP >= 20,
         AGEP <= 70) %>% 
  group_by(AGEP, sex, Major_Category, state) %>% 
  summarise(mean_wage = mean(real_wage, na.rm = T),
            sd_wage = sd(real_wage, na.rm = T)) %>% 
  ggplot(., aes(x = AGEP)) +
  geom_line(aes(y = mean_wage, colour = sex)) +
  geom_line(aes(y = mean_wage + 2 * sd_wage, colour = sex), linetype = "dashed") +
  ggtitle("Data summary: yearly wages (mean + 2 standard deviations)") +
  xlab("age") +
  ylab("yearly wages in USD") +
  facet_grid(state ~ Major_Category)
```

We can see differences in wages, slopes as well as in the gender wage gap when comparing the different panels.
Nothing here is too surprising: business graduates have the highest earning potential, followed by graduates in the field of health, and education graduates coming in last.
Furthermore, it appears that wages grow steadily through people's thirties and forties until growth starts to stall around the age of fifty.
This observation is fairly consistent across all panels.

Looking at the gender wage gap, the gap is consistently smallest within education graduates (at least in terms of absolute numbers). 
While the gap within health and business ends up being roughly similar in older age cohorts, the way there is different:
women with a business background seem to earn less than men right out of the gate, whereas wages only start to separate around age 35 for health graduates.

On a more technical note, we can also see that there is a lot of variation in the wages within each age cohort.
This is not unexpected, however it has implications for our model choice: 
If we were to go ahead and use a regression model that directly models wage (with Gaussian noise) as a function of age, it is very likely that we would end up with negative wages when drawing posterior predictive samples from that model.

In order to avoid this, we log-transform the wage numbers before running our models.
This will ensure that our posterior predictive samples are positive (after exponentiating them) -- and has the convenient side-effect of lowering the impact of high outlier wages.
```{r log_transform}
model_df1 <- nytx_df %>% 
  mutate(log_wage = log(real_wage))
```

While using Gaussian distributions to describe the wage distributions at each age point is of course still an approximation, it is not a terribly outrageous one after log-transforming the wages.
We can see this in the violin plots of select age cohorts (we only show eight because it would start to get cramped with more age cohorts):

```{r violins, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
model_df1 %>% 
  filter(AGEP %in% seq(25, 60, 5)) %>% 
  ggplot(., aes(x = factor(AGEP), y = log_wage)) +
  geom_violin() +
  ggtitle("Data summary: log-transformed yearly wages in eight age cohorts") +
  xlab("age") +
  ylab("log-transformed yearly wages") +
  facet_grid(state ~ Major_Category)
```

# Linear model: a simple start
To kick things off, we fit a hierarchical generalised linear model with Gaussian noise.
As we have discovered when looking at the data summary earlier, wages start to stagnate around the age of fifty.
Therefore, we will only fit the linear model in the age span 25 to 50 -- this is where the wage growth happens.
```{r filter_lin}
lin_df <- model_df1 %>% 
  filter(AGEP >= 25,
         AGEP <= 50)
```

The resulting data frame `lin_df` still contains 85,843 entries.
In order to keep computation times manageable, we reduce the size of the dataset by taking a random sample of 5,000 entries:
```{r sample_lin}
set.seed(42)
prototype_lin_df <- lin_df %>% 
  sample_n(size = 5000)
```

## Model fitting & convergence diagnostics
We can now go ahead and fit a hierarchical generalised linear model using the `stan_glmer()` function from `rstanarm`.
Log-transformed wages will be fitted as a linear function of age with Gaussian noise.
We want to allow for the slope of this function to be different between the genders, so we add `sex` as a grouping term.
In addition, we specify the hierarchical groupings `Major_Category` and `state`.

Sampling takes place with `rstanarm`'s default settings: four chains with 2,000 samples, 1,000 of which are warm-up samples.
Default priors are `N(0, 2.5)` for regression coefficients, `N(0, 10)` for intercepts and `exponential(1)` for `sigma` parameters of the Gaussian noise.
Note that the prior parameters apply after the regression's predictors are centred.
```{r load_stan}
library(rstan)
library(rstanarm)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores() - 1)
```
```{r fit_lin_model, eval=FALSE, echo=TRUE}
lin_fit <- stan_glmer(log_wage ~ (AGEP | sex) + 
                        (1 | Major_Category) + (1 | state),
                      data = prototype_lin_df, family = gaussian(), 
                      adapt_delta = 0.98)
```
```{r load_lin_model, echo=FALSE}
load("data/lin42_98.RData")
```

Let's have a look at the model fit summary, including parameter estimates and convergence diagnostics:
```{r lin_summary, results='asis'}
knitr::kable(lin_fit$stan_summary, digits = 2)
```

All `Rhat` values are below 1.1, giving an indication that the chains have converged.
We can also asses convergence by inspecting the trace plots of the sampling chains (the 1000 samples after warm-up are shown):
```{r load_bayesplot}
library(bayesplot)
theme_set(custom_ggtheme)
```

```{r lin_trace_plot, cache=TRUE, fig.fullwidth=TRUE, fig.width=10, fig.height=8}
mcmc_trace(as.array(lin_fit), np = nuts_params(lin_fit))
```

While the chains are mostly mixed and stationary, there is a noticeable amount of divergences.
We have followed the recommendation of increasing the parameter provided via `adapt_delta` closer to 1 (default is 0.95).
This has reduced, but not eliminated the divergent transitions.
In summary, the number of divergent transitions is something we take note of, but have to accept for now.

## Predictive performance: PSIS-LOO
We can use *Pareto smoothed importance sampling* (PSIS) *leave-one-out* (LOO) *cross-validation* (CV) to assess the predictive performance of the linear model. 
This is done by applying LOO-CV to the log-likelihood matrix of the fitted model.
We can then plot the estimated shape parameters *k* of the generalised Pareto distribution in order to check the reliability of the LOO expected log point-wise predictive (`elpd`) estimate:
```{r lin_kplot, cache=TRUE}
loo_lin <- loo(log_lik(lin_fit))
par(bg = '#fffff8')
plot(loo_lin)
```

All *k* values are below 0.5, indicating quick convergence and solid predictive performance [^5].

## Posterior predictions
With the linear model fitted, we can now draw (4000) posterior predictive samples to answer some of our questions around wages and the gender wage gap.


First, let's have a look at the predicted wages. 
We show the median and central 95% interval for wages in each age cohort:

```{r lin_post_wages, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
post_sample_grid <- expand.grid(AGEP = 25:50, 
                                sex = c("male", "female"), 
                                Major_Category = c("Education", "Health", "Business"), 
                                state = c("NY", "TX"),
                                KEEP.OUT.ATTRS = F,
                                stringsAsFactors = F)

log_post_lin <- posterior_predict(lin_fit, post_sample_grid, seed = 42)
exp_post_lin <- exp(log_post_lin)

post_df <- bind_cols(post_sample_grid, as.data.frame(t(exp_post_lin)))

post_long <- post_df %>% 
  gather(key = "sample_no", value = "predicted_earning", V1:V4000)

ci_post_pred <- post_long %>% 
  group_by(AGEP, sex, Major_Category, state) %>% 
  summarise(q_lower = quantile(predicted_earning, 0.025, names = F),
            median = quantile(predicted_earning, 0.5, names = F),
            q_upper = quantile(predicted_earning, 0.975, names = F),
            q90 = quantile(predicted_earning, 0.9, names = F)) %>% 
  mutate(model = "linear")

ci_post_pred %>% 
  ggplot(., aes(x = AGEP)) +
  geom_line(aes(y = median, colour = sex)) +
  geom_line(aes(y = q_lower, colour = sex), linetype = "dashed") +
  geom_line(aes(y = q_upper, colour = sex), linetype = "dashed") +
  ggtitle("Posterior prediction (linear model): yearly wages (median & central 95% interval)") +
  xlab("age") +
  ylab("yearly wages in USD") +
  facet_grid(state ~ Major_Category)
```

At a first glance, we can already see that the model is not entirely unreasonable:
it has generally replicated the trends we have seen in the real data, including the existence of a gender wage gap.

In order to show the context of real data more explicitly, we can plot the predictions together with the real data.
Note that his time around, we plot the data median and the 90% quantile at each age point (instead of mean & two standard deviations earlier).
Due to high wages being masked in our original dataset, the real data's 97.5% wage quantiles look pretty peculiar (they form a horizontal line across all ages).
As a consequence, the real data may look different in this plot compared to the earlier one.

```{r real_v_lin, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
data_intervals_median <- model_df1 %>% 
  filter(AGEP >= 20,
         AGEP <= 70) %>% 
  group_by(AGEP, sex, Major_Category, state) %>% 
  summarise(median = median(real_wage, na.rm = T),
            q90 = quantile(real_wage, 0.9, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(model = "data")

bind_rows(ci_post_pred, data_intervals_median) %>% 
  mutate(plot_cat = paste0(str_sub(sex, 1, 1), " (", model, ")")) %>% 
  ggplot(., aes(x = AGEP)) +
  geom_line(aes(y = median, colour = plot_cat)) +
  geom_line(aes(y = q90, colour = plot_cat), linetype = "dashed") + 
  scale_colour_manual(values = c("#e31a1c", "#fd8d3c", "#08306b", "#2171b5"),
                      name = "group") +
  ggtitle("Posterior prediction (linear model) & real data: yearly wages (median & 90% quantile)") +
  xlab("age") +
  ylab("yearly wages in USD") +
  facet_grid(state ~ Major_Category)
```

The median values are roughly comparable with the ones in the real data, however our posterior sample shows higher variation than is found in real wage data.
This is especially prominent in the education and health cohorts -- it seems like our particular "hierarchical" implementation does not allow the Gaussian noise of the different major categories to vary a lot.

Now that we have posterior samples, we can use them to investigate some specific aspects of the wage data by deriving quantities from the posterior sample.
One such derivation is to calculate the difference of predicted yearly wages for men and women in each panel.

```{r lin_diff, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
ci_diff<- post_long %>% 
  spread(key = "sex", value = "predicted_earning") %>% 
  mutate(diff_mf = male - female) %>%
  group_by(AGEP, Major_Category, state) %>%
  summarise(q_lower = quantile(diff_mf, 0.025, names = F),
            median = quantile(diff_mf, 0.5, names = F),
            q_upper = quantile(diff_mf, 0.975, names = F))

ci_diff %>%
  ggplot(., aes(x = AGEP)) +
  geom_line(aes(y = median)) +
  geom_line(aes(y = q_lower), linetype = "dashed") +
  geom_line(aes(y = q_upper), linetype = "dashed") +
  ggtitle("Posterior prediction (linear model): wage difference (male - female; central 95% interval)") +
  xlab("age") +
  ylab("difference in yearly wages [USD]") +
  facet_grid(state ~ Major_Category)
```

It seems like there are disparities between the panels when looking at these wage differences.
However, as we have alluded to earlier, this might be entirely due to the fact that the wage levels themselves also vary across the panels.

We can see if that is the case by investigating the wage ratio instead of the difference.
This gives us a relative measure instead of an absolute one.
A ratio like this is best visualised on the `log2` scale:

```{r lin_ratio, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
ci_ratio <- post_long %>% 
  spread(key = "sex", value = "predicted_earning") %>% 
  mutate(ratio_mf = male / female) %>% 
  group_by(AGEP, Major_Category, state) %>% 
  summarise(q_lower = quantile(ratio_mf, 0.025, names = F),
            median = quantile(ratio_mf, 0.5, names = F),
            q_upper = quantile(ratio_mf, 0.975, names = F)) 

ci_ratio %>% 
  ggplot(., aes(x = AGEP)) +
  geom_line(aes(y = log2(median))) +
  geom_line(aes(y = log2(q_lower)), linetype = "dashed") +
  geom_line(aes(y = log2(q_upper)), linetype = "dashed") +
  ggtitle("Posterior prediction (linear model): log2 ratio of wages (male / female; central 95% interval)") +
  xlab("age") +
  ylab("log2 ratio of yearly wages") +
  facet_grid(state ~ Major_Category) 
```

Unfortunately (in terms of interesting outcomes), it does not seem like we can identify any group differences in the relative gender wage gap trend with this linear model:
the slope and location of the time series are practically identical across all six panels.

As unexciting as it may be, this happen-stance actually makes it easier to provide a summary of the predicted wage ratios for workers of different ages by simply taking the mean across all six panels:
```{r lin_ratio_table, results='asis'}
ci_ratio %>% 
  filter(AGEP %in% seq(26, 50, 3)) %>% 
  group_by(AGEP) %>% 
  summarise(mean_lower = mean(q_lower),
            mean_50 = mean(median),
            mean_upper = mean(q_upper)) %>% 
  mutate(mean_lower = paste0("female ", round(1 / mean_lower, 2), "x higher"),
         mean_50 = paste0("male ", round(mean_50, 2), "x higher"),
         mean_upper = paste0("male ", round(mean_upper, 2), "x higher")) %>% 
  knitr::kable(., col.names = c("age", "2.5%", "50%", "97.5%"), align = "rccc")
```

This table shows the trends shown from the previous figure on a more tangible scale than the logarithmic scale: as men's relative wages grow larger with age, the credibility intervals of wage ratios shift accordingly.

# Additive mixed model: ramped up complexity
The linear model above is a fairly simple first approach to modelling our wage data.
With the next model in this report, we increase the complexity substantially (arguably too much so).

The model is a hierarchical *generalised additive mixed model* (GAMM) that also uses the cubic B-spline basis function, which models the predictor (log-transformed wages) as a piecewise continuous function conditioned on a set of knot points (see BDA3 book [^6], chapter 20, pages 487-489 for more details).

## Model fitting & convergence diagnostics
We fit the GAMM using the `rstanarm` function `stan_gamm4()`, using the following priors: `N(0, 2.5)` for regression coefficients, flat uniform for intercepts and `exponential(1)` for the smooth function.

Since this model should be able to pick up more trends than just linear growth during the relatively younger ages, we use a random sample (5000 entries) from the complete dataset to fit it.

```{r fit_gamm_model, eval=FALSE, echo=TRUE}
set.seed(42)
prototype_spline_df <- model_df1 %>%
  sample_n(size = 5000)

log_GAMM <- stan_gamm4(log_wage ~ s(AGEP), 
                       random = ~(sex | Major_Category) + (sex | state),
                       prior_intercept = NULL, 
                       data = prototype_spline_df,
                       family = gaussian())
```
```{r load_gamm_model, echo=FALSE}
load("data/log_GAMM_TR.RData")
```

Again, let's have a look at parameter estimates and convergence diagnostics:
```{r gamm_summary, results='asis'}
knitr::kable(log_GAMM$stan_summary, digits = 2)
```

Just as with the linear model, all `Rhat` values are below 1.1.
This diagnostic indicates that the chains have converged.

Once again, we also inspect the trace plots of the sampling chains:

```{r gamm_trace_plot, cache=TRUE, fig.fullwidth=TRUE, fig.width=10, fig.height=8}
mcmc_trace(as.array(log_GAMM), np = nuts_params(log_GAMM))
```

Compared to the linear model, there are fewer divergent transitions (15), but of course it would be preferable to see even fewer of them.

## Predictive performance: PSIS-LOO
While the number of divergent transitions has improved from the linear model, PSIS-LOO diagnostics are quite bad with the GAMM model:

```{r gamm_kplot, cache=TRUE}
loo_GAMM <- loo(log_lik(log_GAMM))
par(bg = '#fffff8')
plot(loo_GAMM)
```

```{r gamm_ktable, results='asis'}
cbind(c("good", "ok", "bad", "very bad"), loo::pareto_k_table(loo_GAMM)) %>% 
  knitr::kable(.)
```

Around 54% of the Pareto *k* values are bad or very bad, indicating either that the GAMM fit is poor or the model too complex. 

While there are endless options for modifying model priors looking for an improvement, the few we have tried (flat priors for intercept and smooth function) did not improve the model fit.

We also tried to reduce the number of knot points from the 9 knots automatically picked by `rstanarm` to 3 knots located at the first, second and third quantiles, based on the premise that the high number of splines might be overkill.
However, this also did not help regarding the PSIS-LOO diagnostic.

## Posterior predictions
Even though the PSIS-LOO diagnostic indicates a poor fit, we will power through for now.
This means that we again draw (4000) posterior predictive samples from the fitted model.

The first thing we investigate are the central 95% intervals for the predicted wages:

```{r gamm_post_wages, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
GAMM_sample_grid <- expand.grid(AGEP = 20:70, 
                                sex = c("male", "female"), 
                                Major_Category = c("Education", "Health", "Business"), 
                                state = c("NY", "TX"),
                                KEEP.OUT.ATTRS = F,
                                stringsAsFactors = F)

log_post_GAMM <- posterior_predict(log_GAMM, GAMM_sample_grid, seed = 42)
exp_post_GAMM <- exp(log_post_GAMM)

post_GAMM_df <- bind_cols(GAMM_sample_grid, as.data.frame(t(exp_post_GAMM)))

post_GAMM_long <- post_GAMM_df %>% 
  gather(key = "sample_no", value = "predicted_earning", V1:V4000)

ci_post_GAMM_pred <- post_GAMM_long %>% 
  group_by(AGEP, sex, Major_Category, state) %>% 
  summarise(q_lower = quantile(predicted_earning, 0.025, names = F),
            median = quantile(predicted_earning, 0.5, names = F),
            q_upper = quantile(predicted_earning, 0.975, names = F),
            q90 = quantile(predicted_earning, 0.9, names = F)) %>% 
  mutate(model = "GAMM")

ci_post_GAMM_pred %>% 
  ggplot(., aes(x = AGEP)) +
  geom_line(aes(y = median, colour = sex)) +
  geom_line(aes(y = q_lower, colour = sex), linetype = "dashed") +
  geom_line(aes(y = q_upper, colour = sex), linetype = "dashed") +
  ggtitle("Posterior prediction (GAMM): yearly wages (median & central 95% interval)") +
  xlab("age") +
  ylab("yearly wages in USD") +
  facet_grid(state ~ Major_Category)
```

It appears that the GAMM has picked up the different earning potentials of the three major categories -- business and health are highest, with education trailing behind.

While women's predicted wages are consistently lower then men's, the shape of the two curves does not dramatically differ.
At most, we could say that the wage curve for women is a bit flatter than the one for men.

We can also once again show the predicted wages in the context of the real data:
```{r real_v_gamm, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
bind_rows(ci_post_GAMM_pred, data_intervals_median) %>% 
  mutate(plot_cat = paste0(str_sub(sex, 1, 1), " (", model, ")")) %>% 
  ggplot(., aes(x = AGEP)) +
  geom_line(aes(y = median, colour = plot_cat)) +
  geom_line(aes(y = q90, colour = plot_cat), linetype = "dashed") + 
  scale_colour_manual(values = c("#e31a1c", "#fd8d3c", "#08306b", "#2171b5"),
                      name = "group") +
  ggtitle("Posterior prediction (GAMM) & real data: yearly wages (median & 90% quantile)") +
  xlab("age") +
  ylab("yearly wages in USD") +
  facet_grid(state ~ Major_Category)
```
Across all panels, we observe the same problem that was present with the linear model:
a predicted wage variation that is substantially higher than the one present in the real data.
In addition, it seems like the GAMM is not able to pick up that real-world median wages don't seem to drop off for health graduates of older ages.
Those things aside, we can say that at least the predicted median wages track real-world medians reasonably well.

Just as we did when evaluating the linear model, we can use the posterior samples to describe the gender wage gap.
We will skip showing the differences in absolute wages this time and go straight to the relative wage ratios:

```{r gamm_ratio, fig.fullwidth=TRUE, fig.width=10, fig.height=6.5, cache=TRUE}
ci_GAMM_ratio <- post_GAMM_long %>% 
  spread(key = "sex", value = "predicted_earning") %>% 
  mutate(ratio_mf = male / female) %>% 
  group_by(AGEP, Major_Category, state) %>% 
  summarise(q_lower = quantile(ratio_mf, 0.025, names = F),
            median = quantile(ratio_mf, 0.5, names = F),
            q_upper = quantile(ratio_mf, 0.975, names = F)) 

ci_GAMM_ratio %>% 
  ggplot(., aes(x = AGEP)) +
  geom_line(aes(y = log2(median))) +
  geom_line(aes(y = log2(q_lower)), linetype = "dashed") +
  geom_line(aes(y = log2(q_upper)), linetype = "dashed") +
  ggtitle("Posterior prediction (GAMM): log2 ratio of wages (male / female; central 95% interval)") +
  xlab("age") +
  ylab("log2 ratio of yearly wages") +
  facet_grid(state ~ Major_Category) 
```

While the linear model showed an increase in the wage gap toward higher ages, but no differences between the panels, we have the opposite problem with the GAMM:
the time series lines are pretty much horizontal in all panels, their vertical position, however, differs when comparing the different major categories.

Once again, we can make our observations from the ratio plot more explicit by summarising the interval boundaries and the median for specific groups.
This time, we group by age as well as major category.
These groupings show the situation off fairly well -- ratios within one major category are constant across all ages, but there are differences between the major categories:

```{r gamm_ratio_table, results='asis'}
ci_GAMM_ratio %>% 
  filter(AGEP %in% c(25, 35, 45, 55)) %>% 
  group_by(Major_Category, AGEP) %>% 
  summarise(mean_lower = mean(q_lower),
            mean_50 = mean(median),
            mean_upper = mean(q_upper)) %>% 
  mutate(mean_lower = paste0("female ", round(1 / mean_lower, 2), "x higher"),
         mean_50 = paste0("male ", round(mean_50, 2), "x higher"),
         mean_upper = paste0("male ", round(mean_upper, 2), "x higher")) %>% 
  knitr::kable(., col.names = c("major category", "age", "2.5%", "50%", "97.5%"), 
               align = "lrccc")
```

# Conclusions and thoughts
As you probably have realised by now, we did not exaggerate by mentioning in the introduction that *we cannot claim that the presented work provides groundbreaking answers to any unsolved research questions surrounding the gender wage gap*.

Unfortunately, the models we ran have not provided any substantial findings.
We could demonstrate that the wage gap exists across all ages and backgrounds, but frankly, that's an observation which could probably be made just by looking at the census data summary plots that we provided early on in the report -- although, to be fair, creating those actually did require a non-zero amount of data cleaning work.

So what went wrong?

Let's deal with the elephant in the room right away:
we did not do ourselves any favours only using `rstanarm` functions instead of writing out explicit *Stan* models. 
The downsides here are (at least) twofold.

First off, the flexibility during model construction, allowed by sampling methods such as Hamiltonian Monte Carlo, is arguably the biggest strength of modern Bayesian methods.
While `rstanarm` allows plenty of flexibility for many standard applications like the regression models we have attempted to use, it is inherently less flexible than "proper" *Stan* models are.

Furthermore, using `rstanarm` functions introduces a level of abstraction into the process of building, fitting and checking models.
Even though there have been fairly obvious problems with some of the models we tried in this project -- frankly, even with the ones that made it into this report -- we often found ourselves somewhat unable to tackle these problems within the syntax of `rstanarm`.
Obviously, most of this is due to our inexperience with the Bayesian workflow in real-world settings and it would be unfair to just blame all our shortcomings on the interface we used.
However, for better or worse, the workflow seems to be more immediate and sometimes easier to figure out when writing explicit *Stan* models.

Speaking of workflow, it turns out this workflow is a lot harder to perform when there is no clear analysis path laid out for you (like it was during the assignments).
In hindsight, this particular dataset was probably a bit too large for beginners such as ourselves.
Because of the sheer amount of data entries, which was accompanied by insecurity about whether and how to reduce the amount of data -- we also considered using summary statistics instead of individual records -- it was actually not trivial to quickly try out new model set-ups or priors:
While prototypes could be fitted within seconds during the assignments, sampling run-time easily exceeded an hour for some of the models we tried here.

Bottom line, while the project didn't really lead to any research findings, we have learned plenty about applying the Bayesian workflow in practice.
We will leave the research -- at least the one in this field -- to the experts.

[^1]: Corbett, Christianne, and Catherine Hill. “Graduating to a Pay Gap: The Earnings of Women and Men One Year after College Graduation. American Association of University Women.” 1111 Sixteenth Street NW, Washington, DC 20036 (2012).

[^2]: Heathcote, Jonathan, Kjetil Storesletten, and Giovanni L. Violante. "The macroeconomic implications of rising wage inequality in the United States." Journal of political economy 118.4 (2010): 681-722.

[^3]: Blau, Francine D., and Lawrence M. Kahn. "The gender wage gap: Extent, trends, and explanations." Journal of Economic Literature 55.3 (2017): 789-865.

[^4]: Carnevale et al., "What's It Worth?: The Economic Value of College Majors." Georgetown University Center on Education and the Workforce, 2011. [Website](http://cew.georgetown.edu/whatsitworth)

[^5]: Vehtari, Aki, Andrew Gelman, and Jonah Gabry. "Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC." Statistics and Computing 27.5 (2017): 1413-1432.

[^6]: Gelman, A., Carlin, J.B., Stern, H. S., Dunson, D. B., Vehtari, A. and Rubin, D. B. Bayesian Data Analysis, Third Edition (Chapman & Hall/CRC Texts in Statistical Science).
